---
- hosts: all
  vars:
drupal
  tasks:
    - include_tasks: "tasks/npm-install.yml"
    - include_tasks: "tasks/composer-install.yml"

    - name: "Check if directory exists"
      file: "path={{ BUILD_DIR }} state=directory"

    - name: "Sync local host to remote"
      synchronize:
        src: "{{ CI_PROJECT_DIR }}"
        dest: "{{ BUILD_DIR }}/.."
        delete: true
        rsync_opts:
          - "--chmod=F664"
          - "--chmod=D775"
          - "--exclude-from=/excludes.txt"

    - name: Add docksal.env file
      template:
        src: ../templates/docksal.env.j2
        dest: "{{ DOCKSAL_ENV_FILE }}"
        force: true

    - name: Restart docksal container with fin up
      shell: source ~/.zshrc && fin up
      register: output
      args:
        executable: /bin/zsh
        chdir: "{{ BUILD_DIR }}"

    - name: Composer install
      shell: source ~/.zshrc && composer install --ignore-platform-reqs --quiet --no-interaction {{ COMPOSER_INSTALL_FLAGS }}
      args:
        executable: /bin/zsh
        chdir: "{{ BUILD_DIR }}"

    - name: Check if site is already installed.
      shell: "fin bash status bootstrap"
      args:
        chdir: "{{ BUILD_DIR }}/{{ DRUPAL_DOCROOT }}"
        executable: /bin/zsh
      register: drupal_site_installed
      failed_when: "drupal_site_installed.stdout is undefined"
      changed_when: false

    - debug:
        msg: "Site installed"
      when: drupal_site_installed

    - include_tasks: "tasks/install-site.yml"
      when: drupal_site_installed != true

    - include_tasks: "tasks/update-site.yml"
      when: drupal_site_installed

    - name: Clear drupal cache
      shell: source ~/.zshrc && fin drush cr
      args:
        executable: /bin/zsh
        chdir: "{{ BUILD_DIR }}/{{ DRUPAL_DOCROOT }}"
      ignore_errors: yes