---
- hosts: all
  vars:
    - CI_ENVIRONMENT_URL: "{{ lookup('env','CI_ENVIRONMENT_URL') | default('test.dev.b-connect.eu', true) }}"
    - CI_PROJECT_NAMESPACE: "{{ lookup('env','CI_PROJECT_NAMESPACE') | default('test-dev', true) }}"
    - CI_PROJECT_NAME: "{{ lookup('env','CI_PROJECT_NAME') | default('test-dev', true) }}"
    - CI_ENVIRONMENT_SLUG: "{{ lookup('env','CI_ENVIRONMENT_SLUG') | default('dev', true) }}"
    - CI_REPOSITORY_URL: "{{ lookup('env','CI_REPOSITORY_URL') | default('dev', true) }}"
    - CI_PROJECT_DIR: "{{ lookup('env','CI_PROJECT_DIR') | default('/builds/gitlab-org/gitlab-ce', true) }}"
    - BUILD_DIR: "/home/{{ ansible_user }}/ansible/{{ CI_ENVIRONMENT_SLUG }}/{{ CI_PROJECT_NAMESPACE}}/{{ CI_PROJECT_NAME }}"
    - DOCKSAL_ENV_FILE: "{{ BUILD_DIR }}/.docksal/docksal-local.env"
    - DOCKSAL_ADD_VIRTUAL_HOSTS: "{{ lookup('env','DOCKSAL_ADD_VIRTUAL_HOSTS') }}"
    - DRUPAL_SITE_INSTALL_FLAGS: "{{ lookup('env','DRUPAL_SITE_INSTALL_FLAGS') | default('', true) }}"
    - COMPOSER_INSTALL_FLAGS: "{{ lookup('env','COMPOSER_INSTALL_FLAGS') | default('', true) }}"
    - DRUPAL_SITE_CONFIG: "{{ lookup('env','DRUPAL_SITE_CONFIG') }}"
    - DRUPAL_PROFILE: "{{ lookup('env','DRUPAL_PROFILE') | default('standard', true) }}"
    - DRUPAL_ACCOUNT_NAME: "{{ lookup('env','DRUPAL_ACCOUNT_NAME') | default('admin', true) }}"
    - DRUPAL_ACCOUNT_PASS: "{{ lookup('env','DRUPAL_ACCOUNT_PASS') | default('admin', true) }}"
    - DRUPAL_DOCROOT: "{{ lookup('env','DRUPAL_DOCROOT') | default('docroot', true) }}"

  tasks:
    - name: "Check if directory exists"
      file: "path={{ BUILD_DIR }} state=directory"

    - include_tasks: "tasks/composer-install.yml"
    - include_tasks: "tasks/npm-install.yml"

    - name: "Sync local host to remote"
      synchronize:
        src: "{{ CI_PROJECT_DIR }}"
        dest: "{{ BUILD_DIR }}/.."
        delete: true
        rsync_opts:
          - "--chmod=F664"
          - "--chmod=D775"
          - "--exclude-from=/excludes.txt"

    - name: Add docksal.env file
      template:
        src: ../templates/docksal.env.j2
        dest: "{{ DOCKSAL_ENV_FILE }}"
        force: true

    - name: Restart docksal container with fin up
      shell: source ~/.zshrc && fin up
      register: output
      args:
        executable: /bin/zsh
        chdir: "{{ BUILD_DIR }}"

    - name: Composer install
      shell: source ~/.zshrc && composer install --ignore-platform-reqs --quiet --no-interaction {{ COMPOSER_INSTALL_FLAGS }}
      args:
        executable: /bin/zsh
        chdir: "{{ BUILD_DIR }}"

    - name: Check if site is already installed.
      shell: "fin bash status bootstrap"
      args:
        chdir: "{{ BUILD_DIR }}/{{ DRUPAL_DOCROOT }}"
        executable: /bin/zsh
      register: drupal_site_installed
      failed_when: "drupal_site_installed.stdout is undefined"
      changed_when: false

    - debug:
        msg: "Site installed"
      when: drupal_site_installed

    - include_tasks: "tasks/install-site.yml"
      when: drupal_site_installed != true

    - include_tasks: "tasks/update-site.yml"
      when: drupal_site_installed

    - name: Clear drupal cache
      shell: source ~/.zshrc && fin drush cr
      args:
        executable: /bin/zsh
        chdir: "{{ BUILD_DIR }}/{{ DRUPAL_DOCROOT }}"
      ignore_errors: yes